<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Previous Year Papers - ExamPrep Hub</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <a href="index.html">ExamPrep Hub</a>
      </div>
      <ul class="nav-menu">
        <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
        <li class="nav-item"><a href="exams.html" class="nav-link">Exams</a></li>
        <li class="nav-item"><a href="schedule.html" class="nav-link">Schedule</a></li>
        <li class="nav-item"><a href="calendar.html" class="nav-link">Exam Calendar</a></li>
        <li class="nav-item"><a href="videos.html" class="nav-link">Videos</a></li>
        <li class="nav-item"><a href="papers.html" class="nav-link active">Previous Papers</a></li>
        <li class="nav-item"><a href="login.html" class="nav-link login-btn">Login</a></li>
      </ul>
      <div class="hamburger">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
      </div>
    </div>
  </nav>

  <main class="papers-main">
    <div class="container">
      <h1>Previous Year Papers</h1>
      
      <!-- Filters -->
      <div id="filters" class="papers-filter">
        <div class="filter-group">
          <label for="examFilter">Filter by Exam:</label>
          <select id="examFilter" onchange="applyFilters()">
            <option value="">All Exams</option>
            <option value="UPSC_CSE">UPSC</option>
            <option value="MPSC_SS">MPSC</option>
            <option value="SSC_CGL">SSC</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="yearFilter">Filter by Year:</label>
          <select id="yearFilter" onchange="applyFilters()">
            <option value="">All Years</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="typeFilter">Filter by Type:</label>
          <select id="typeFilter" onchange="applyFilters()">
            <option value="">All Types</option>
            <option value="prelims">Prelims</option>
            <option value="mains">Mains</option>
            <option value="interview">Interview</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="searchBox">Search:</label>
          <input type="text" id="searchBox" placeholder="Search papers..." oninput="applyFilters()">
        </div>
      </div>

      <!-- Papers container -->
      <div id="papersContainer" class="papers-grid">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i> Loading papers...
        </div>
      </div>
    </div>
  </main>

  <!-- PDF Viewer Modal -->
  <div id="pdfViewer" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="pdfTitle"></h3>
        <span class="close" onclick="closePdfViewer()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="pdfLoading" class="pdf-loading">
          <i class="fas fa-spinner fa-spin"></i> Loading PDF...
        </div>
        <iframe id="pdfFrame" width="100%" height="500px" style="display: none;" onload="hidePdfLoading()"></iframe>
        <div id="pdfError" class="pdf-error" style="display: none;">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Unable to load PDF. Please try downloading the file instead.</p>
          <button class="btn btn-download" onclick="downloadCurrentPdf()">
            <i class="fas fa-download"></i> Download PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p>Â© Error404. All rights reserved.</p>
    </div>
  </footer>

  <script>
    let papers = [];
    let filteredPapers = [];

    // Load papers (try API, fallback to static)
    async function loadPapers() {
      try {
        // Try API first
        let apiPapers = [];
        try {
          const response = await fetch('/api/papers?limit=200');
          if (response.ok) {
            const contentType = response.headers.get('content-type') || '';
            let data = null;
            if (contentType.includes('application/json')) {
              try { data = await response.json(); } catch (_) { data = null; }
            } else {
              const text = await response.text();
              if (text && text.trim().length) {
                try { data = JSON.parse(text); } catch (_) { data = null; }
              }
            }
            if (data && Array.isArray(data.papers)) {
              apiPapers = data.papers;
            }
          }
        } catch (e) {
          // Ignore and fallback to static
        }

        if (apiPapers.length > 0) {
          papers = apiPapers;
        } else {
          // Fallback: Static PDFs (mapped to files in uploads/papers)
          papers = [
            {
              id: 'static-ssc-2023-tier2',
              isStatic: true,
              title: "SSC CGL 2023 Tier II Question Paper",
              description: "Official SSC CGL paper with answers",
              year: 2023,
              exam_name: "SSC",
              exam_code: "SSC_CGL",
              paper_type: "mains",
              file_path: "uploads/papers/ssc cgl paper.pdf",
              download_count: 0
            },
            {
              id: 'static-upsc-2023-prelims',
              isStatic: true,
              title: "UPSC Civil Services Prelims 2023",
              description: "UPSC Prelims 2023 official question paper",
              year: 2023,
              exam_name: "UPSC",
              exam_code: "UPSC_CSE",
              paper_type: "prelims",
              file_path: "uploads/papers/upsc 2023.pdf",
              download_count: 0
            },
            {
              id: 'static-mpsc-2023-mains',
              isStatic: true,
              title: "MPSC State Services 2023",
              description: "MPSC State Services question paper",
              year: 2023,
              exam_name: "MPSC",
              exam_code: "MPSC_SS",
              paper_type: "mains",
              file_path: "uploads/papers/mpsc paper.pdf",
              download_count: 0
            }
          ];
        }

        filteredPapers = [...papers];
        renderPapers();
        updateFilters();
      } catch (error) {
        console.error('Error loading papers:', error);
        document.getElementById('papersContainer').innerHTML = 
          '<div class="error">Error loading papers. Please try again.</div>';
      }
    }

    // Render papers
    function renderPapers() {
      const container = document.getElementById('papersContainer');
      container.innerHTML = '';

      if (filteredPapers.length === 0) {
        container.innerHTML = '<div class="no-papers">No papers found matching your criteria.</div>';
        return;
      }

      filteredPapers.forEach(paper => {
        const div = document.createElement('div');
        div.className = 'paper-card';
        div.innerHTML = `
          <h3>${paper.title}</h3>
          <p class="paper-description">${paper.description || 'No description available'}</p>
          <div class="paper-meta">
            <span class="paper-year">${paper.year}</span>
            <span class="paper-type">${paper.paper_type}</span>
          </div>
          <div class="paper-info">
            <small><strong>Exam:</strong> ${paper.exam_name}</small>
            <small><i class="fas fa-download"></i> ${paper.download_count || 0} downloads</small>
          </div>
          <div class="paper-actions">
            <button class="btn btn-view" onclick="viewPdf('${paper.file_path}', '${paper.title.replace(/'/g, "&#39;")}')">
              <i class="fas fa-eye"></i> View
            </button>
            <button class="btn btn-download" onclick="downloadPaper(${paper.id})">
              <i class="fas fa-download"></i> Download
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Update filter options
    function updateFilters() {
      const years = [...new Set(papers.map(p => p.year))].sort((a, b) => b - a);
      const yearSelect = document.getElementById('yearFilter');
      yearSelect.innerHTML = '<option value="">All Years</option>';
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      });
    }

    // Apply filters
    function applyFilters() {
      const examFilter = document.getElementById('examFilter').value;
      const yearFilter = document.getElementById('yearFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const searchTerm = document.getElementById('searchBox').value.toLowerCase();

      filteredPapers = papers.filter(paper => {
        const matchesExam = !examFilter || paper.exam_code === examFilter;
        const matchesYear = !yearFilter || paper.year == yearFilter;
        const matchesType = !typeFilter || paper.paper_type === typeFilter;
        const matchesSearch = !searchTerm || 
          paper.title.toLowerCase().includes(searchTerm) ||
          (paper.description && paper.description.toLowerCase().includes(searchTerm));

        return matchesExam && matchesYear && matchesType && matchesSearch;
      });

      renderPapers();
    }

    // View PDF
    function viewPdf(filePath, title) {
      const filename = filePath.split('/').pop();
      const pdfUrl = encodeURI(filePath);

      window.currentPdfPath = filePath;

      document.getElementById('pdfTitle').textContent = title || filename;
      document.getElementById('pdfLoading').style.display = 'block';
      document.getElementById('pdfFrame').style.display = 'none';
      document.getElementById('pdfError').style.display = 'none';
      document.getElementById('pdfViewer').style.display = 'flex';

      const iframe = document.getElementById('pdfFrame');
      iframe.src = pdfUrl;

      // Fallback: if not loaded within 5s, show error with download option
      if (window.__pdfLoadTimeout) {
        clearTimeout(window.__pdfLoadTimeout);
      }
      window.__pdfLoadTimeout = setTimeout(() => {
        if (document.getElementById('pdfFrame').style.display === 'none') {
          document.getElementById('pdfLoading').style.display = 'none';
          document.getElementById('pdfError').style.display = 'block';
        }
      }, 5000);
    }

    // Hide loading and show PDF
    function hidePdfLoading() {
      document.getElementById('pdfLoading').style.display = 'none';
      document.getElementById('pdfFrame').style.display = 'block';
      if (window.__pdfLoadTimeout) {
        clearTimeout(window.__pdfLoadTimeout);
        window.__pdfLoadTimeout = null;
      }
    }

    // Download current PDF
    function downloadCurrentPdf() {
      if (window.currentPdfPath) {
        const filename = window.currentPdfPath.split('/').pop();
        const link = document.createElement('a');
        link.href = encodeURI(window.currentPdfPath);
        link.download = filename;
        link.click();
      }
    }

    // Download paper
    async function downloadPaper(paperId) {
      const paper = papers.find(p => p.id === paperId);
      if (!paper) return;

      // If paper is from API, record download
      if (!paper.isStatic && typeof paper.id !== 'string') {
        try {
          const res = await fetch(`/api/papers/${paper.id}/download`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          if (res.ok) {
            const contentType = res.headers.get('content-type') || '';
            let data = null;
            if (contentType.includes('application/json')) {
              try { data = await res.json(); } catch (_) { data = null; }
            } else {
              const text = await res.text();
              if (text && text.trim().length) {
                try { data = JSON.parse(text); } catch (_) { data = null; }
              }
            }
            const href = encodeURI((data && data.paper && data.paper.filePath) || paper.file_path);
            const link = document.createElement('a');
            link.href = href;
            link.download = paper.title + ".pdf";
            link.click();
            return;
          }
        } catch (e) {
          // Fallback to direct download
        }
      }

      // Verify file exists before attempting direct download
      try {
        const head = await fetch(encodeURI(paper.file_path), { method: 'HEAD' });
        if (!head.ok) throw new Error('Missing file');
        const link = document.createElement('a');
        link.href = encodeURI(paper.file_path);
        link.download = paper.title + ".pdf";
        link.click();
      } catch (e) {
        alert('File not found. Please ensure the PDF exists at ' + paper.file_path);
      }
    }

    // Close PDF modal
    function closePdfViewer() {
      document.getElementById('pdfViewer').style.display = 'none';
      document.getElementById('pdfFrame').src = '';
      document.getElementById('pdfFrame').style.display = 'none';
      document.getElementById('pdfLoading').style.display = 'block';
      document.getElementById('pdfError').style.display = 'none';
      window.currentPdfPath = null;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadPapers();

      document.getElementById('pdfViewer').addEventListener('click', (e) => {
        if (e.target === document.getElementById('pdfViewer')) {
          closePdfViewer();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.getElementById('pdfViewer').style.display === 'flex') {
          closePdfViewer();
        }
      });
    });
  </script>

  <style>
    /* Minimal styles for modal and buttons specific to papers page */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal-content {
      background: #fff;
      width: 90%;
      max-width: 900px;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
    }
    .modal-header h3 { margin: 0; }
    .modal-header .close { cursor: pointer; font-size: 22px; }
    .modal-body { padding: 0; background: #f7f7f7; }
    .pdf-loading, .pdf-error { padding: 16px; text-align: center; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent, #ff8e6c);
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn:hover { filter: brightness(0.95); }
    .btn-view { background: var(--primary, #e96224); }
    .btn-download { background: var(--accent, #ff8e6c); }
    .paper-actions { display: flex; gap: 10px; }
  </style>
</body>
</html>
